function TreeViewHandler(treeview_instance){var tv=this;this.treeview=jQuery("#"+treeview_instance+"_in");this.loadingImage=jQuery("#"+treeview_instance+"_loading");this.toolbox=jQuery("#tv_tools");this.buttons=jQuery(".tv_button:first",this.toolbox);this.zoom=100;this.boxWidth=180;this.boxExpandedWidth=250;this.cookieDays=3;this.ajaxUrl="module.php?mod=tree&ged="+encodeURIComponent(WT_GEDCOM)+"&instance="+treeview_instance+"&mod_action=";this.container=this.treeview.parent();this.auto_box_width=false;this.updating=false;if(readCookie("compact")==="true"){tv.compact()}tv.treeview.draggable({cursor:"move",stop:function(){tv.updateTree()}});tv.toolbox.find("#tvbCompact").each(function(index,tvCompact){tvCompact.onclick=function(){tv.compact()}});tv.toolbox.find("#tvbAllPartners").each(function(index,tvAllPartners){tvAllPartners.onclick=function(){createCookie("allPartners",readCookie("allPartners")==="true"?"false":"true",tv.cookieDays);document.location=document.location}});tv.toolbox.find("#tvbOpen").each(function(index,tvbOpen){var b=jQuery(tvbOpen,tv.toolbox);tvbOpen.onclick=function(){b.addClass("tvPressed");tv.setLoading();var e=jQuery.Event("click");tv.treeview.find(".tv_box:not(.boxExpanded)").each(function(index,box){var pos=jQuery(box,tv.treeview).offset();if(pos.left>=tv.leftMin&&pos.left<=tv.leftMax&&pos.top>=tv.topMin&&pos.top<=tv.topMax){tv.expandBox(box,e)}});b.removeClass("tvPressed");tv.setComplete()}});tv.toolbox.find("#tvbClose").each(function(index,tvbClose){var b=jQuery(tvbClose,tv.toolbox);tvbClose.onclick=function(){b.addClass("tvPressed");tv.setLoading();tv.treeview.find(".tv_box.boxExpanded").each(function(index,box){jQuery(box).css("display","none").removeClass("boxExpanded").parent().find(".tv_box.collapsedContent").css("display","block")});b.removeClass("tvPressed");tv.setComplete()}});tv.centerOnRoot()}TreeViewHandler.prototype.setLoading=function(){this.treeview.css("cursor","wait");this.loadingImage.css("display","block")};TreeViewHandler.prototype.setComplete=function(){this.treeview.css("cursor","move");this.loadingImage.css("display","none")};TreeViewHandler.prototype.getSize=function(){var tv=this;var container=tv.container.parent();var offset=container.offset();tv.leftMin=offset.left;tv.leftMax=tv.leftMin+container.innerWidth();tv.topMin=offset.top;tv.topMax=tv.topMin+container.innerHeight()};TreeViewHandler.prototype.updateTree=function(center,button){var tv=this;var to_load=[];var elts=[];this.getSize();tv.treeview.find("td[abbr]").each(function(index,el){el=jQuery(el,tv.treeview);var pos=el.offset();if(pos.left>=tv.leftMin&&pos.left<=tv.leftMax&&pos.top>=tv.topMin&&pos.top<=tv.topMax){to_load.push(el.attr("abbr"));elts.push(el)}});if(to_load.length>0){tv.updating=true;tv.setLoading();jQuery.ajax({url:tv.ajaxUrl+"getPersons",dataType:"json",data:"q="+to_load.join(";"),success:function(ret){var nb=elts.length;var root_element=jQuery(".rootPerson",this.treeview);var l=root_element.offset().left;for(var i=0;i<nb;i++){elts[i].removeAttr("abbr").html(ret[i])}tv.treeview.offset({left:tv.treeview.offset().left-root_element.offset().left+l});tv.getSize()},complete:function(){if(tv.treeview.find("td[abbr]").length){tv.updateTree(center,button)}if(tv.auto_box_width){tv.treeview.find(".tv_box").css("width","auto")}tv.updating=true;if(center){tv.centerOnRoot()}if(button){button.removeClass("tvPressed")}tv.setComplete();tv.updating=false},timeout:function(){if(button){button.removeClass("tvPressed")}tv.updating=false;tv.setComplete()}})}else{if(button){button.removeClass("tvPressed")}tv.setComplete()}return false};TreeViewHandler.prototype.compact=function(){var tv=this;var b=jQuery("#tvbCompact",tv.toolbox);tv.setLoading();if(tv.auto_box_width){var w=tv.boxWidth*(tv.zoom/100)+"px";var ew=tv.boxExpandedWidth*(tv.zoom/100)+"px";tv.treeview.find(".tv_box:not(boxExpanded)",tv.treeview).css("width",w);tv.treeview.find(".boxExpanded",tv.treeview).css("width",ew);tv.auto_box_width=false;if(readCookie("compact")){createCookie("compact",false,tv.cookieDays)}b.removeClass("tvPressed")}else{tv.treeview.find(".tv_box").css("width","auto");tv.auto_box_width=true;if(!readCookie("compact")){createCookie("compact",true,tv.cookieDays)}if(!tv.updating){tv.updateTree()}b.addClass("tvPressed")}tv.setComplete();return false};TreeViewHandler.prototype.centerOnRoot=function(){this.loadingImage.css("display","block");var tvc=this.container;var tvc_width=tvc.innerWidth()/2;if(isNaN(tvc_width)){return false}var tvc_height=tvc.innerHeight()/2;var root_person=jQuery(".rootPerson",this.treeview);this.treeview.offset({left:tvc.offset().left+this.treeview.offset().left+tvc_width-root_person.offset().left-root_person.outerWidth()/2,top:tvc.offset().top+this.treeview.offset().top+tvc_height-root_person.offset().top-root_person.outerHeight()/2});if(!this.updating){this.updateTree(true)}return false};TreeViewHandler.prototype.expandBox=function(box,event){var t=jQuery(event.target);if(t.hasClass("tv_link")){return false}var box=jQuery(box,this.treeview);var bc=box.parent();var pid=box.attr("abbr");var tv=this;var expanded;var collapsed;if(bc.hasClass("detailsLoaded")){collapsed=bc.find(".collapsedContent");expanded=bc.find(".tv_box:not(.collapsedContent)")}else{expanded=box;collapsed=box.clone();bc.append(collapsed.addClass("collapsedContent").css("display","none"));var loading_image=this.loadingImage.find("img").clone().addClass("tv_box_loading").css("display","block");box.prepend(loading_image);tv.updating=true;tv.setLoading();box.load(tv.ajaxUrl+"getDetails&pid="+pid,function(){if(typeof CB_Init==="function"){CB_Init()}box.css("width",tv.boxExpandedWidth*(tv.zoom/100)+"px");loading_image.remove();bc.addClass("detailsLoaded");tv.setComplete();tv.updating=false})}if(box.hasClass("boxExpanded")){expanded.css("display","none");collapsed.css("display","block");box.removeClass("boxExpanded")}else{expanded.css("display","block");collapsed.css("display","none");expanded.addClass("boxExpanded")}this.getSize();return false};function createCookie(name,value,days){if(days){var date=new Date;date.setTime(date.getTime()+days*24*60*60*1e3);document.cookie=name+"="+value+"; expires="+date.toGMTString()+"; path=/"}else{document.cookie=name+"="+value+"; path=/"}}function readCookie(name){var name_equals=name+"=";var ca=document.cookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)===" "){c=c.substring(1,c.length)}if(c.indexOf(name_equals)===0){return c.substring(name_equals.length,c.length)}}return null}